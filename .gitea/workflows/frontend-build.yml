# .gitea/workflows/frontend-ci-cd.yml

name: å‰ç«¯æ„å»ºä¸å‘å¸ƒ (å†…ç½‘ç‰ˆ)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # ç¡®ä¿æ­¤å®¹å™¨å†…åŒ…å«: node, npm, git, curl, tar (æ¨èå†åŒ…å« jq)
    container: docker.xuanyuan.me/node:18

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        # Gitea ä¼šè‡ªåŠ¨æ£€å‡ºä»£ç åˆ°å·¥ä½œç›®å½•ï¼Œæ‰€ä»¥é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨ clone
        # å¦‚æœéœ€è¦ç¡®ä¿æ˜¯æœ€æ–°ä»£ç ï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤
        run: |
          echo "ä»£ç å·²ç”± Gitea Runner è‡ªåŠ¨æ£€å‡ºåˆ°å½“å‰ç›®å½•ã€‚"
          ls -la
          
      - name: 2. è®¾ç½®å·¥ä½œç›®å½•å¹¶å®‰è£…ä¾èµ–
        # ä½¿ç”¨ defaults è®¾ç½®åç»­æ­¥éª¤çš„é»˜è®¤å·¥ä½œç›®å½•ï¼Œä½¿è„šæœ¬æ›´æ•´æ´
        defaults:
          run:
            working-directory: ./frontend
        run: |
          echo "è¿›å…¥ frontend ç›®å½•..."
          npm ci

      - name: 3. è¿è¡Œ Lint å’Œæµ‹è¯• (å¯é€‰ä½†å¼ºçƒˆæ¨è)
        defaults:
          run:
            working-directory: ./frontend
        run: |
          # ç¡®ä¿ package.json ä¸­æœ‰ lint å’Œ test è„šæœ¬
          if npm run --silent lint; then
            echo "ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡ã€‚"
          else
            echo "::error::ä»£ç é£æ ¼æ£€æŸ¥å¤±è´¥ï¼"
            exit 1
          fi
          
          if npm run --silent test; then
            echo "å•å…ƒæµ‹è¯•é€šè¿‡ã€‚"
          else
            echo "::error::å•å…ƒæµ‹è¯•å¤±è´¥ï¼"
            exit 1
          fi

      - name: 4. æ„å»ºå‰ç«¯é¡¹ç›®
        defaults:
          run:
            working-directory: ./frontend
        run: npm run build
      
      - name: 5. æ‰“åŒ…å¹¶å‘å¸ƒåˆ° Gitea Release (ä»…åœ¨æ¨é€ Tag æ—¶æ‰§è¡Œ)
        # ä½¿ç”¨ Gitea çš„å†…ç½®å˜é‡æ¥åˆ¤æ–­äº‹ä»¶ç±»å‹
        if: startsWith(gitea.ref, 'refs/tags/v')
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          echo "æ£€æµ‹åˆ° Tag æ¨é€ï¼Œå¼€å§‹åˆ›å»º Release..."
          
          # å‡†å¤‡å˜é‡
          RELEASE_TAG="${GITEA_REF_NAME}"
          ARCHIVE_NAME="frontend-dist-${RELEASE_TAG}.tar.gz"
          RELEASE_API_URL="${GITEA_API_URL}/repos/${GITEA_REPOSITORY}/releases"

          # 1. åˆ›å»ºå½’æ¡£æ–‡ä»¶
          echo "æ­£åœ¨æ‰“åŒ…æ„å»ºäº§ç‰©..."
          cd frontend
          tar -czf "../${ARCHIVE_NAME}" dist/
          cd ..
          echo "æ‰“åŒ…å®Œæˆ: ${ARCHIVE_NAME}"

          # 2. å‡†å¤‡ Release çš„ Body å†…å®¹
          # ä½¿ç”¨ cat å’Œ EOF å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºå¤šè¡Œå­—ç¬¦ä¸²
          RELEASE_BODY=$(cat <<EOF
          ## ğŸš€ Release ${RELEASE_TAG}

          è¿™æ˜¯å‰ç«¯é¡¹ç›®çš„è‡ªåŠ¨åŒ–å‘å¸ƒç‰ˆæœ¬ã€‚

          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ \`${ARCHIVE_NAME}\` æ–‡ä»¶ã€‚
          2. è§£å‹åˆ°ä½ çš„ Web æœåŠ¡å™¨æ ¹ç›®å½•ã€‚
          3. é…ç½® Web æœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰æŒ‡å‘è§£å‹åçš„ \`dist\` ç›®å½•ã€‚

          ---
          *æ­¤ç‰ˆæœ¬ç”± Gitea Actions è‡ªåŠ¨ç”Ÿæˆã€‚*
          EOF
          )

          # 3. é€šè¿‡ Gitea API åˆ›å»º Release
          echo "æ­£åœ¨åˆ›å»º Release..."
          # ä½¿ç”¨ jq è§£æ API å“åº”æ¥è·å– upload_urlã€‚å¦‚æœæ²¡è£… jqï¼Œä¼šæ”¹ç”¨ grep/sed
          if command -v jq &> /dev/null
          then
            # ä½¿ç”¨ jq çš„ç‰ˆæœ¬ (æ›´å¥å£®)
            RESPONSE=$(curl --silent -X POST "${RELEASE_API_URL}" \
              -H "Authorization: token ${GITEA_TOKEN}" \
              -H "Content-Type: application/json" \
              -d @- <<PAYLOAD
              {
                "tag_name": "${RELEASE_TAG}",
                "name": "Release ${RELEASE_TAG}",
                "body": "${RELEASE_BODY}"
              }
              PAYLOAD
            )
            UPLOAD_URL=$(echo "${RESPONSE}" | jq -r .upload_url)
          else
            # ä¸ä½¿ç”¨ jq çš„ç‰ˆæœ¬ (å…¼å®¹æ€§å¥½)
            RESPONSE=$(curl --silent -X POST "${RELEASE_API_URL}" \
              -H "Authorization: token ${GITEA_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"tag_name\": \"${RELEASE_TAG}\", \"name\": \"Release ${RELEASE_TAG}\", \"body\": \"${RELEASE_BODY}\"}"
            )
            UPLOAD_URL=$(echo "${RESPONSE}" | grep -o '"upload_url":"[^"]*' | sed 's/"upload_url":"//')
          fi

          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" == "null" ]; then
            echo "::error::åˆ›å»º Release å¤±è´¥æˆ–æœªèƒ½è·å–åˆ°ä¸Šä¼  URLã€‚"
            echo "API å“åº”: ${RESPONSE}"
            exit 1
          fi
          echo "Release åˆ›å»ºæˆåŠŸï¼Œä¸Šä¼  URL: ${UPLOAD_URL}"

          # 4. ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºé™„ä»¶
          echo "æ­£åœ¨ä¸Šä¼ é™„ä»¶..."
          curl --silent -X POST "${UPLOAD_URL}?name=${ARCHIVE_NAME}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@${ARCHIVE_NAME}"

          echo "é™„ä»¶ ${ARCHIVE_NAME} ä¸Šä¼ æˆåŠŸï¼"
          echo "æµç¨‹å®Œæˆã€‚"