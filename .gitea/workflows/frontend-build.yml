# .gitea/workflows/frontend-ci-cd.yml

name: å‰ç«¯æ„å»ºä¸å‘å¸ƒ (å†…ç½‘è°ƒè¯•ç‰ˆ)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container: docker.xuanyuan.me/node:18

    steps:
      - name: 1. æ£€å‡ºä»£ç 
        # ä¿®æ­£ï¼šä½¿ç”¨æ ‡å‡†çš„ actions/checkout æ¥çœŸæ­£åœ°æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è°ƒè¯•ï¼šæ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•æ–‡ä»¶ç»“æ„
        run: |
          echo "å½“å‰å·¥ä½œç›®å½• (pwd):"
          pwd
          echo "---"
          echo "åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶å’Œç›®å½• (ls -laR):"
          ls -laR
          echo "---"

      - name: 2. å®‰è£…ä¾èµ–
        run: |
          echo "å‡†å¤‡è¿›å…¥ frontend ç›®å½•..."
          cd frontend
          
          echo "å·²è¿›å…¥ç›®å½•ï¼Œå½“å‰å·¥ä½œç›®å½• (pwd):"
          pwd
          echo "---"
          
          echo "åˆ—å‡º frontend ç›®å½•ä¸‹çš„æ–‡ä»¶ (ls -la):"
          ls -la
          echo "---"
          
          echo "ç°åœ¨ï¼Œå¼€å§‹æ‰§è¡Œ npm ci..."
          npm ci

      - name: 3. è¿è¡Œ Lint å’Œæµ‹è¯•
        run: |
          cd frontend
          # ç¡®ä¿ package.json ä¸­æœ‰ lint å’Œ test è„šæœ¬
          if npm run --silent lint; then
            echo "ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡ã€‚"
          else
            echo "::error::ä»£ç é£æ ¼æ£€æŸ¥å¤±è´¥ï¼"
            exit 1
          fi
          
          if npm run --silent test; then
            echo "å•å…ƒæµ‹è¯•é€šè¿‡ã€‚"
          else
            echo "::error::å•å…ƒæµ‹è¯•å¤±è´¥ï¼"
            exit 1
          fi

      - name: 4. æ„å»ºå‰ç«¯é¡¹ç›®
        run: |
          cd frontend
          npm run build
          echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥ dist ç›®å½•:"
          # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ£€æŸ¥ frontend/distï¼Œä½†å› ä¸ºä½ å·²ç» cd frontend äº†ï¼Œæ‰€ä»¥è·¯å¾„æ˜¯ dist/
          ls -la dist/
      
      - name: 5. æ‰“åŒ…å¹¶å‘å¸ƒåˆ° Gitea Release (ä»…åœ¨æ¨é€ Tag æ—¶æ‰§è¡Œ)
        if: startsWith(gitea.ref, 'refs/tags/v')
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          echo "æ£€æµ‹åˆ° Tag æ¨é€ï¼Œå¼€å§‹åˆ›å»º Release..."
          
          RELEASE_TAG="${GITEA_REF_NAME}"
          # ä¿®æ­£æ‰“åŒ…è·¯å¾„ï¼Œæ‰“åŒ…æ–‡ä»¶å°†åˆ›å»ºåœ¨å·¥ä½œåŒºæ ¹ç›®å½•
          ARCHIVE_NAME="frontend-dist-${RELEASE_TAG}.tar.gz"
          RELEASE_API_URL="${GITEA_API_URL}/repos/${GITEA_REPOSITORY}/releases"

          echo "æ­£åœ¨æ‰“åŒ…æ„å»ºäº§ç‰©..."
          tar -czf "${ARCHIVE_NAME}" -C frontend/ dist/
          echo "æ‰“åŒ…å®Œæˆ: ${ARCHIVE_NAME}"
          
          RELEASE_BODY=$(cat <<EOF
          ## ğŸš€ Release ${RELEASE_TAG}
          è¿™æ˜¯å‰ç«¯é¡¹ç›®çš„è‡ªåŠ¨åŒ–å‘å¸ƒç‰ˆæœ¬ã€‚
          EOF
          )

          RESPONSE=$(curl --silent -X POST "${RELEASE_API_URL}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\": \"${RELEASE_TAG}\", \"name\": \"Release ${RELEASE_TAG}\", \"body\": \"${RELEASE_BODY}\"}"
          )
          
          UPLOAD_URL=$(echo "${RESPONSE}" | grep -o '"upload_url":"[^"]*' | sed 's/"upload_url":"//')

          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" == "null" ]; then
            echo "::error::åˆ›å»º Release å¤±è´¥æˆ–æœªèƒ½è·å–åˆ°ä¸Šä¼  URLã€‚"
            echo "API å“åº”: ${RESPONSE}"
            exit 1
          fi

          echo "æ­£åœ¨ä¸Šä¼ é™„ä»¶..."
          curl --silent -X POST "${UPLOAD_URL}?name=${ARCHIVE_NAME}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@${ARCHIVE_NAME}"

          echo "æµç¨‹å®Œæˆã€‚"