# .gitea/workflows/frontend-ci-cd.yml

name: å‰ç«¯æ„å»ºä¸å‘å¸ƒ

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    container: docker.xuanyuan.me/node:18

    steps:
      - name: 1. æ‰‹åŠ¨æ£€å‡ºä»£ç 
        env:
          # GITEA_TOKEN æ˜¯ç”± Gitea è‡ªåŠ¨æ³¨å…¥çš„ä¸´æ—¶ä»¤ç‰Œï¼Œç”¨äºè®¤è¯
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          echo "================================================="
          echo " STEP 1: MANUALLY CHECKING OUT SOURCE CODE"
          echo "================================================="
          
          # ç¡®ä¿ git å¯ç”¨
          if ! command -v git &> /dev/null
          then
              echo "::error::git command not found. Please ensure git is installed in the container."
              apt update && apt install -y git
          fi
          
          # é…ç½® git å®‰å…¨ç›®å½•ï¼Œé¿å… 'dubious ownership' é”™è¯¯
          # GITEA_WORKSPACE æ˜¯ Gitea Runner æ³¨å…¥çš„å½“å‰å·¥ä½œåŒºè·¯å¾„
          git config --global --add safe.directory "${GITEA_WORKSPACE}"

          # æ‹¼æ¥å¸¦è®¤è¯ä¿¡æ¯çš„ä»“åº“ URL
          # GITEA_SERVER_URL å’Œ GITEA_REPOSITORY æ˜¯ Gitea è‡ªåŠ¨æä¾›çš„ç¯å¢ƒå˜é‡
          # ä¾‹å¦‚: GITEA_SERVER_URL=http://gitea.example.com, GITEA_REPOSITORY=myuser/myrepo
          REPO_URL="${GITEA_SERVER_URL}/${GITEA_REPOSITORY}.git"
          
          # ä½¿ç”¨ 'gitea-actions' ä½œä¸ºç‰¹æ®Šç”¨æˆ·åå’Œ GITEA_TOKEN ä½œä¸ºå¯†ç è¿›è¡Œè®¤è¯
          AUTH_REPO_URL=$(echo "$REPO_URL" | sed "s|://|://gitea-actions:${GITEA_TOKEN}@|")
          
          echo "Cloning repository from ${GITEA_REPOSITORY}..."
          
          # ä½¿ç”¨ --depth=1 è¿›è¡Œæµ…å…‹éš†ä»¥åŠ å¿«é€Ÿåº¦ï¼Œå¹¶æŒ‡å®šåˆ†æ”¯
          # æ³¨æ„ï¼šå¯¹äº tag push, GITEA_REF_NAME æ˜¯ tag name (e.g., v1.0.0)
          # å¯¹äº branch push, GITEA_REF_NAME æ˜¯ branch name (e.g., main)
          git clone --depth=1 --branch="${GITEA_REF_NAME}" "${AUTH_REPO_URL}" .
          
          # å¯¹äº Pull Requestï¼ŒGITEA_REF_NAME å¯èƒ½æ˜¯ 'main', ä½†æˆ‘ä»¬éœ€è¦çš„æ˜¯ PR çš„ HEAD
          # ä¸è¿‡ï¼Œå¯¹äº push å’Œ tag äº‹ä»¶ï¼Œä¸Šé¢çš„ clone å·²ç»è¶³å¤Ÿäº†ã€‚
          # ä¸ºäº†ç¡®ä¿å·¥ä½œåŒºä»£ç ä¸è§¦å‘äº‹ä»¶çš„ commit å®Œå…¨ä¸€è‡´ï¼Œå†æ‰§è¡Œä¸€æ¬¡ checkout
          echo "Checking out the specific commit: ${GITEA_SHA}"
          git fetch origin "${GITEA_SHA}"
          git checkout "${GITEA_SHA}"
          
          echo "Source code checked out successfully."
          echo "-------------------------------------------------"

      - name: è°ƒè¯•ï¼šæ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•æ–‡ä»¶ç»“æ„
        run: |
          echo "Current working directory (pwd):"
          pwd
          echo "---"
          echo "Listing all files and directories (ls -laR):"
          ls -laR
          echo "---"

      - name: 2. å®‰è£…ä¾èµ–
        run: |
          echo "Entering 'frontend' directory..."
          cd frontend
          
          echo "Current directory (pwd):"
          pwd
          echo "---"
          
          echo "Listing files in 'frontend' (ls -la):"
          ls -la
          echo "---"
          
          echo "Starting 'npm ci' to install dependencies..."
          npm ci

      - name: 3. è¿è¡Œ Lint å’Œæµ‹è¯•
        working-directory: ./frontend # ä½¿ç”¨ working-directory ç®€åŒ– cd æ“ä½œ
        run: |
          if npm run --silent lint; then
            echo "Lint check passed."
          else
            echo "::error::Lint check failed!"
            exit 1
          fi
          
          if npm run --silent test; then
            echo "Unit tests passed."
          else
            echo "::error::Unit tests failed!"
            exit 1
          fi

      - name: 4. æ„å»ºå‰ç«¯é¡¹ç›®
        working-directory: ./frontend
        run: |
          npm run build
          echo "Build complete. Checking 'dist' directory:"
          ls -la dist/
      
      - name: 5. æ‰“åŒ…å¹¶å‘å¸ƒåˆ° Gitea Release (ä»…åœ¨æ¨é€ Tag æ—¶æ‰§è¡Œ)
        if: startsWith(gitea.ref, 'refs/tags/v')
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          echo "Tag push detected, creating Gitea Release..."
          
          RELEASE_TAG="${GITEA_REF_NAME}"
          ARCHIVE_NAME="frontend-dist-${RELEASE_TAG}.tar.gz"
          RELEASE_API_URL="${GITEA_API_URL}/repos/${GITEA_REPOSITORY}/releases"

          echo "Archiving build artifacts..."
          # -C frontend/ dist/ è¡¨ç¤ºåˆ‡æ¢åˆ° frontend ç›®å½•ï¼Œç„¶åæ‰“åŒ…å…¶ä¸‹çš„ dist ç›®å½•
          tar -czf "${ARCHIVE_NAME}" -C frontend/ dist/
          echo "Archive created: ${ARCHIVE_NAME}"
          
          # ä½¿ç”¨ Heredoc è¯­æ³•åˆ›å»ºå¤šè¡Œå­—ç¬¦ä¸²
          RELEASE_BODY=$(cat <<EOF
          ## ğŸš€ Release ${RELEASE_TAG}
          This is an automated release for the frontend project.
          EOF
          )

          echo "Creating release for tag ${RELEASE_TAG}..."
          RESPONSE=$(curl --silent --show-error -X POST "${RELEASE_API_URL}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\": \"${RELEASE_TAG}\", \"name\": \"Release ${RELEASE_TAG}\", \"body\": \"${RELEASE_BODY}\"}"
          )
          
          # ä½¿ç”¨ jq (å¦‚æœå¯ç”¨) æˆ– grep/sed è§£æ JSON
          UPLOAD_URL=$(echo "${RESPONSE}" | grep -o '"upload_url":"[^"]*' | sed 's/"upload_url":"//')

          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" == "null" ]; then
            echo "::error::Failed to create release or get upload URL."
            echo "API Response: ${RESPONSE}"
            exit 1
          fi

          echo "Uploading attachment to ${UPLOAD_URL}..."
          curl --silent --show-error -X POST "${UPLOAD_URL}?name=${ARCHIVE_NAME}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@${ARCHIVE_NAME}"

          echo "Process completed successfully."